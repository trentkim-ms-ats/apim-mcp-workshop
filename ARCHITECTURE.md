# Azure APIM + MCP 서버 아키텍처

## 전체 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          클라이언트 레이어                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                 │
│  │   GitHub     │    │  Azure AI    │    │   Custom     │                 │
│  │   Copilot    │    │   Foundry    │    │   MCP Client │                 │
│  │              │    │   Agent      │    │   (Python)   │                 │
│  └───────┬──────┘    └───────┬──────┘    └───────┬──────┘                 │
│          │                   │                    │                         │
│          └───────────────────┴────────────────────┘                         │
│                              │                                               │
│                              │ HTTPS + Bearer JWT Token                     │
│                              │                                               │
└──────────────────────────────┼───────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Azure Entra ID (인증 레이어)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────┐          │
│  │  OAuth 2.0 / OpenID Connect                                   │          │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────────────────┐  │          │
│  │  │ API App    │  │ Client App │  │ External Tenant (B2B)  │  │          │
│  │  │ (MCP API)  │  │            │  │ (Guest Users)          │  │          │
│  │  └────────────┘  └────────────┘  └────────────────────────┘  │          │
│  └──────────────────────────────────────────────────────────────┘          │
│                              │                                               │
│                              │ JWT Token (Validated)                        │
│                              │                                               │
└──────────────────────────────┼───────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                 Azure API Management (게이트웨이 레이어)                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │  Inbound Policies                                                   │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐  │    │
│  │  │ CORS         │  │ JWT          │  │ Rate Limiting            │  │    │
│  │  │ Configuration│  │ Validation   │  │ (100 calls/min)          │  │    │
│  │  └──────────────┘  └──────────────┘  └──────────────────────────┘  │    │
│  │  ┌──────────────┐  ┌──────────────┐                                 │    │
│  │  │ Request      │  │ Header       │                                 │    │
│  │  │ Transform    │  │ Management   │                                 │    │
│  │  └──────────────┘  └──────────────┘                                 │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │  Backend Routing                                                    │    │
│  │  ┌─────────────────────┐         ┌─────────────────────────────┐   │    │
│  │  │ MCP Functions       │         │ External REST APIs          │   │    │
│  │  │ Backend             │         │ (Weather, GitHub, Custom)   │   │    │
│  │  │ (Internal)          │         │ (Public/Private)            │   │    │
│  │  └─────────────────────┘         └─────────────────────────────┘   │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │  Outbound Policies                                                  │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐  │    │
│  │  │ Response     │  │ MCP Protocol │  │ Diagnostics &            │  │    │
│  │  │ Transform    │  │ Headers      │  │ Logging                  │  │    │
│  │  └──────────────┘  └──────────────┘  └──────────────────────────┘  │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  Gateway URL: https://{apim-name}.azure-api.net/mcp                        │
│                                                                              │
└──────────────────┬───────────────────────────────┬───────────────────────────┘
                   │                               │
                   │                               │
        ┌──────────▼──────────┐         ┌──────────▼──────────────┐
        │                     │         │                          │
        │                     │         │                          │
┌───────────────────────────────────┐   │  ┌────────────────────────────────┐
│   Azure Functions (MCP 서버)       │   │  │   External REST APIs           │
├───────────────────────────────────┤   │  ├────────────────────────────────┤
│                                    │   │  │                                 │
│  ┌──────────────────────────────┐ │   │  │  ┌──────────────────────────┐  │
│  │ Function App (Python 3.12)   │ │   │  │  │ Weather API              │  │
│  │                              │ │   │  │  │ https://api.weather.com  │  │
│  │ Endpoints:                   │ │   │  │  └──────────────────────────┘  │
│  │ • GET  /mcp/health           │ │   │  │                                 │
│  │ • GET  /mcp/info             │ │   │  │  ┌──────────────────────────┐  │
│  │ • GET  /mcp/tools            │ │   │  │  │ GitHub API               │  │
│  │ • POST /mcp/tools            │ │   │  │  │ https://api.github.com   │  │
│  │ • POST /mcp/messages         │ │   │  │  └──────────────────────────┘  │
│  │                              │ │   │  │                                 │
│  │ Tools Implemented:           │ │   │  │  ┌──────────────────────────┐  │
│  │ ✓ echo                       │ │   │  │  │ Custom Internal APIs     │  │
│  │ ✓ get_current_time           │ │   │  │  │ (Private/VNet)           │  │
│  │ ✓ calculate                  │ │   │  │  └──────────────────────────┘  │
│  └──────────────────────────────┘ │   │  │                                 │
│                                    │   │  │  APIM transforms requests       │
│  System-assigned Managed Identity │   │  │  from MCP → REST format         │
│                                    │   │  │  and responses REST → MCP       │
└──────────┬─────────────────────────┘   │  └─────────────────────────────────┘
           │                             │
           │                             │
           ▼                             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         모니터링 & 관찰성 레이어                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐         ┌──────────────────────────────────┐  │
│  │ Application Insights     │         │ Log Analytics Workspace          │  │
│  │                          │◄────────┤                                  │  │
│  │ • Request/Response       │         │ • 30 day retention               │  │
│  │ • Performance Metrics    │         │ • Structured Logs                │  │
│  │ • Exceptions & Errors    │         │ • Kusto Queries                  │  │
│  │ • Custom Events          │         │                                  │  │
│  │ • User Analytics         │         │                                  │  │
│  └─────────────────────────┘         └──────────────────────────────────┘  │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ APIM Diagnostics                                                     │   │
│  │ • API Call Traces                                                    │   │
│  │ • Policy Execution Logs                                              │   │
│  │ • Backend Performance                                                │   │
│  │ • Sampling: 100%                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                           지원 서비스                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────┐    ┌──────────────────────┐                      │
│  │ Storage Account      │    │ App Service Plan     │                      │
│  │ • Functions Storage  │    │ • Linux              │                      │
│  │ • TLS 1.2+           │    │ • Consumption/Premium│                      │
│  │ • LRS                │    │ • Auto-scale         │                      │
│  └──────────────────────┘    └──────────────────────┘                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 데이터 흐름 (Data Flow)

### 1. 인증된 MCP Tool 호출

```
┌────────────┐
│ MCP Client │
└──────┬─────┘
       │ 1. Request Access Token
       ▼
┌──────────────┐
│ Entra ID     │ 2. OAuth 2.0 Client Credentials
│              │    Returns JWT Token
└──────┬───────┘
       │ 3. Tool Call with JWT
       ▼
┌──────────────────────┐
│ APIM Gateway         │ 4. Validate JWT
│                      │    Check aud, iss, scp
│                      │    Extract user claims
└──────┬───────────────┘
       │ 5. Forward to Backend
       ▼
┌──────────────────────┐
│ Azure Functions      │ 6. Execute Tool
│ MCP Server           │    (echo, calculate, etc.)
└──────┬───────────────┘
       │ 7. Return MCP Result
       ▼
┌──────────────────────┐
│ APIM Gateway         │ 8. Add MCP Headers
│                      │    Log to App Insights
└──────┬───────────────┘
       │ 9. MCP Response
       ▼
┌────────────┐
│ MCP Client │ 10. Process Result
└────────────┘
```

### 2. REST API → MCP 변환

```
┌────────────┐
│ MCP Client │ 1. MCP Tool Call
└──────┬─────┘    {name: "get_weather", arguments: {city: "Seoul"}}
       │
       ▼
┌──────────────────────┐
│ APIM Gateway         │ 2. Transform Request Policy
│                      │    Extract: city = "Seoul"
│                      │    Rewrite URL: /weather?q=Seoul&appid=xxx
│                      │    Method: GET
└──────┬───────────────┘
       │ 3. REST API Call
       ▼
┌──────────────────────┐
│ Weather API          │ 4. Weather Data (JSON)
│ (External)           │    {temp: 5, weather: "Clear", ...}
└──────┬───────────────┘
       │ 5. REST Response
       ▼
┌──────────────────────┐
│ APIM Gateway         │ 6. Transform Response Policy
│                      │    Convert to MCP format:
│                      │    {content: [{type: "text", text: "..."}]}
└──────┬───────────────┘
       │ 7. MCP Response
       ▼
┌────────────┐
│ MCP Client │ 8. Display Weather Info
└────────────┘
```

## 보안 계층 (Security Layers)

```
┌─────────────────────────────────────────┐
│ Layer 5: Monitoring & Audit             │
│ • Application Insights                  │
│ • APIM Diagnostics                      │
│ • Audit Logs (Entra ID)                 │
└─────────────────────────────────────────┘
                   ▲
┌─────────────────────────────────────────┐
│ Layer 4: Authorization                  │
│ • JWT Claims (scp, roles)               │
│ • APIM Policy-based Access Control      │
│ • User-level Permissions                │
└─────────────────────────────────────────┘
                   ▲
┌─────────────────────────────────────────┐
│ Layer 3: Authentication                 │
│ • OpenID Connect                        │
│ • JWT Validation (APIM)                 │
│ • Entra ID Integration                  │
└─────────────────────────────────────────┘
                   ▲
┌─────────────────────────────────────────┐
│ Layer 2: Network Security               │
│ • HTTPS Only (TLS 1.2+)                 │
│ • Rate Limiting                         │
│ • IP Filtering (Optional)               │
│ • VNet Integration (Optional)           │
└─────────────────────────────────────────┘
                   ▲
┌─────────────────────────────────────────┐
│ Layer 1: Identity & Access              │
│ • Managed Identity                      │
│ • RBAC                                  │
│ • Key Vault (Optional)                  │
└─────────────────────────────────────────┘
```

## 확장 시나리오

### 시나리오 1: Multi-Region 배포

```
        ┌─────────────┐
        │   Traffic   │
        │   Manager   │
        └──────┬──────┘
               │
       ┌───────┴───────┐
       │               │
       ▼               ▼
┌────────────┐   ┌────────────┐
│ APIM       │   │ APIM       │
│ Korea      │   │ US West    │
│ Central    │   │            │
└─────┬──────┘   └─────┬──────┘
      │                │
      ▼                ▼
┌────────────┐   ┌────────────┐
│ Functions  │   │ Functions  │
│ Korea      │   │ US West    │
└────────────┘   └────────────┘
```

### 시나리오 2: Private Network

```
┌──────────────────────────────┐
│ Virtual Network (VNet)       │
│                              │
│  ┌────────────────────────┐  │
│  │ Private Subnet         │  │
│  │                        │  │
│  │  ┌──────────────────┐  │  │
│  │  │ APIM (Internal)  │  │  │
│  │  └────────┬─────────┘  │  │
│  │           │            │  │
│  │  ┌────────▼─────────┐  │  │
│  │  │ Functions        │  │  │
│  │  │ (VNet Integrated)│  │  │
│  │  └──────────────────┘  │  │
│  └────────────────────────┘  │
│                              │
│  ┌────────────────────────┐  │
│  │ Private Endpoints      │  │
│  │ • Storage              │  │
│  │ • Key Vault            │  │
│  └────────────────────────┘  │
└──────────────────────────────┘
         ▲
         │ Private Link
         │
┌────────┴──────────┐
│ On-premises /     │
│ Peered VNets      │
└───────────────────┘
```

## 성능 최적화

```
┌────────────┐
│ Client     │
└──────┬─────┘
       │ 1. Request
       ▼
┌──────────────────────┐
│ Azure Front Door     │ • CDN
│ (Optional)           │ • SSL Offload
└──────┬───────────────┘ • DDoS Protection
       │
       ▼
┌──────────────────────┐
│ APIM Gateway         │ • Response Caching
│                      │ • Request Batching
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ Functions (Premium)  │ • Pre-warmed Instances
│                      │ • No Cold Start
│                      │ • VNet Integration
└──────────────────────┘
```

---

이 아키텍처는 엔터프라이즈 환경에서 MCP 서버를 안전하고 확장 가능하게 배포하기 위한 
완전한 패턴을 제공합니다.
