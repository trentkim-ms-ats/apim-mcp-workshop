<policies>
    <inbound>
        <base />
    </inbound>
    
    <backend>
        <base />
    </backend>
    
    <outbound>
        <base />
        
        <!-- REST API 응답을 MCP 포맷으로 변환 -->
        
        <!-- 원본 응답 저장 -->
        <set-variable name="original-response" value="@(context.Response.Body.As&lt;string&gt;(preserveContent: true))" />
        
        <!-- MCP 응답 포맷으로 변환 -->
        <set-body>@{
            var originalBody = context.Variables.GetValueOrDefault&lt;string&gt;("original-response");
            
            try {
                // JSONPlaceholder Todos 응답 처리
                // 배열인 경우: 할 일 목록 (list_todos)
                // 객체인 경우: 단일 할 일 (get_todo)
                
                if (originalBody.TrimStart().StartsWith("[")) {
                    // 배열 응답: 할 일 목록
                    var todos = JArray.Parse(originalBody);
                    var sb = new System.Text.StringBuilder();
                    sb.AppendLine("할 일 목록 (처음 5개):");
                    sb.AppendLine("-------------------------");
                    
                    int count = todos.Count &gt; 5 ? 5 : todos.Count;
                    for (int i = 0; i &lt; count; i++) {
                        var todo = todos[i];
                        var status = (bool)todo["completed"] ? "[완료]" : "[미완료]";
                        sb.AppendLine(status + " [" + todo["id"] + "] " + todo["title"]);
                    }
                    
                    sb.AppendLine("-------------------------");
                    sb.AppendLine("총 " + todos.Count + "개의 할 일이 있습니다.");
                    
                    var mcpResponse = new JObject();
                    mcpResponse["content"] = new JArray(
                        new JObject(
                            new JProperty("type", "text"),
                            new JProperty("text", sb.ToString())
                        )
                    );
                    return mcpResponse.ToString();
                    
                } else {
                    // 객체 응답: 단일 할 일
                    var todo = JObject.Parse(originalBody);
                    var status = (bool)todo["completed"] ? "완료" : "미완료";
                    var text = string.Format(
                        "할 일 상세\n-------------------------\nID: {0}\n제목: {1}\n상태: {2}\n담당자 ID: {3}",
                        todo["id"],
                        todo["title"],
                        status,
                        todo["userId"]
                    );
                    
                    var mcpResponse = new JObject();
                    mcpResponse["content"] = new JArray(
                        new JObject(
                            new JProperty("type", "text"),
                            new JProperty("text", text)
                        )
                    );
                    return mcpResponse.ToString();
                }
                
            } catch (Exception ex) {
                // 변환 실패 시 에러 응답
                var errorResponse = new JObject();
                errorResponse["content"] = new JArray(
                    new JObject(
                        new JProperty("type", "text"),
                        new JProperty("text", "응답 변환 오류: " + ex.Message)
                    )
                );
                errorResponse["isError"] = true;
                
                return errorResponse.ToString();
            }
        }</set-body>
        
        <!-- Content-Type 설정 -->
        <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
        </set-header>
        
        <!-- 로깅 -->
        <trace source="transform-response" severity="information">
            <message>Transformed REST API response to MCP format</message>
        </trace>
    </outbound>
    
    <on-error>
        <base />
        
        <!-- 에러도 MCP 포맷으로 변환 -->
        <return-response>
            <set-status code="@(context.Response.StatusCode)" />
            <set-header name="Content-Type" exists-action="override">
                <value>application/json</value>
            </set-header>
            <set-body>@{
                var errorResponse = new JObject();
                errorResponse["content"] = new JArray(
                    new JObject(
                        new JProperty("type", "text"),
                        new JProperty("text", context.LastError?.Message ?? "Unknown error")
                    )
                );
                errorResponse["isError"] = true;
                
                return errorResponse.ToString();
            }</set-body>
        </return-response>
    </on-error>
</policies>
