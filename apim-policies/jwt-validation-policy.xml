<policies>
    <inbound>
        <base />
        
        <!-- JWT 토큰 검증 (OpenID Connect) -->
        <validate-jwt header-name="Authorization" 
                      failed-validation-httpcode="401" 
                      failed-validation-error-message="Unauthorized: Invalid or missing JWT token">
            
            <!-- OpenID Connect 설정 (Entra ID) -->
            <openid-config url="https://login.microsoftonline.com/{{TENANT_ID}}/v2.0/.well-known/openid-configuration" />
            
            <!-- Audience 검증 -->
            <audiences>
                <audience>api://{{API_APP_ID}}</audience>
            </audiences>
            
            <!-- Issuer 검증 -->
            <issuers>
                <issuer>https://sts.windows.net/{{TENANT_ID}}/</issuer>
                <issuer>https://login.microsoftonline.com/{{TENANT_ID}}/v2.0</issuer>
            </issuers>
            
            <!-- 필수 클레임 검증 -->
            <required-claims>
                <claim name="aud">
                    <value>api://{{API_APP_ID}}</value>
                </claim>
                <claim name="scp" match="any">
                    <value>mcp.access</value>
                    <value>user_impersonation</value>
                </claim>
            </required-claims>
        </validate-jwt>
        
        <!-- JWT 클레임을 컨텍스트 변수로 저장 -->
        <set-variable name="user-id" value="@{
            var jwt = context.Request.Headers.GetValueOrDefault("Authorization", "").Replace("Bearer ", "");
            if (string.IsNullOrEmpty(jwt)) return "anonymous";
            
            try {
                var token = new System.IdentityModel.Tokens.Jwt.JwtSecurityToken(jwt);
                return token.Claims.FirstOrDefault(c => c.Type == "oid")?.Value ?? 
                       token.Claims.FirstOrDefault(c => c.Type == "sub")?.Value ?? 
                       "unknown";
            } catch {
                return "invalid";
            }
        }" />
        
        <set-variable name="user-email" value="@{
            var jwt = context.Request.Headers.GetValueOrDefault("Authorization", "").Replace("Bearer ", "");
            if (string.IsNullOrEmpty(jwt)) return "anonymous";
            
            try {
                var token = new System.IdentityModel.Tokens.Jwt.JwtSecurityToken(jwt);
                return token.Claims.FirstOrDefault(c => c.Type == "upn")?.Value ?? 
                       token.Claims.FirstOrDefault(c => c.Type == "email")?.Value ?? 
                       "unknown";
            } catch {
                return "invalid";
            }
        }" />
        
        <!-- 사용자 정보를 헤더로 전달 (Backend로) -->
        <set-header name="X-User-Id" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("user-id", "anonymous"))</value>
        </set-header>
        
        <set-header name="X-User-Email" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("user-email", "anonymous"))</value>
        </set-header>
        
        <!-- 감사 로그 -->
        <trace source="jwt-validation" severity="information">
            <message>JWT validated successfully</message>
            <metadata name="user-id" value="@(context.Variables.GetValueOrDefault<string>("user-id"))" />
            <metadata name="user-email" value="@(context.Variables.GetValueOrDefault<string>("user-email"))" />
            <metadata name="timestamp" value="@(DateTime.UtcNow.ToString("o"))" />
        </trace>
    </inbound>
    
    <backend>
        <base />
    </backend>
    
    <outbound>
        <base />
    </outbound>
    
    <on-error>
        <base />
        
        <!-- JWT 검증 실패 시 상세 에러 반환 -->
        <return-response>
            <set-status code="401" reason="Unauthorized" />
            <set-header name="Content-Type" exists-action="override">
                <value>application/json</value>
            </set-header>
            <set-header name="WWW-Authenticate" exists-action="override">
                <value>Bearer realm="Azure APIM MCP", error="invalid_token", error_description="JWT validation failed"</value>
            </set-header>
            <set-body>@{
                return new JObject(
                    new JProperty("error", new JObject(
                        new JProperty("code", "unauthorized"),
                        new JProperty("message", context.LastError?.Message ?? "JWT validation failed"),
                        new JProperty("timestamp", DateTime.UtcNow.ToString("o"))
                    ))
                ).ToString();
            }</set-body>
        </return-response>
    </on-error>
</policies>
